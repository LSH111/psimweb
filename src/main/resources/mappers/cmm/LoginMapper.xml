<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.psim.web.cmm.mapper.LoginMapper">
    <select id="findUserById" resultType="com.psim.web.cmm.vo.CoUserVO">
        SELECT user_id    AS userId,
               user_pw    AS userPw,
               user_nm    AS userNm,
               mbtlnum    as mbtlnum,
               sigungu_cd AS sigunguCd, LEFT (TRIM (sigungu_cd), 2) AS sidoCd
        FROM cpk.tb_co_user
        WHERE user_id = #{userId}
    </select>

    <select id="login" resultType="com.psim.web.cmm.vo.CoUserVO">
        SELECT user_id    AS userId,
               user_pw    AS userPw,
               user_nm    AS userNm,
               mbtlnum    as mbtlnum,
               sigungu_cd AS sigunguCd, LEFT (TRIM (sigungu_cd), 2) AS sidoCd
        FROM cpk.tb_co_user
        WHERE user_id = #{userId}
          AND user_pw = #{password}
    </select>

    <select id="loginWithHash" resultType="com.psim.web.cmm.vo.CoUserVO">
        SELECT user_id    AS userId,
               user_pw    AS userPw,
               user_nm    AS userNm,
               mbtlnum    as mbtlnum,
               sigungu_cd AS sigunguCd, LEFT (TRIM (sigungu_cd), 2) AS sidoCd
        FROM cpk.tb_co_user
        WHERE user_id = #{userId}
          AND user_pw = #{hashedPassword}
    </select>

    <!-- üî• ÏÇ¨Ïö©ÏûêÍ∞Ä Ï†ëÍ∑º Í∞ÄÎä•Ìïú ÏÇ¨ÏóÖÍ¥ÄÎ¶¨Î≤àÌò∏ Î™©Î°ù Ï°∞Ìöå -->
    <select id="selectUserBizList" parameterType="string" resultType="string">
        SELECT DISTINCT bpp.prk_biz_mng_no
        FROM cpk.tb_biz_per_prklot_info bpp
                 INNER JOIN cpk.tb_prk_srvy_biz_info psb
                            ON bpp.prk_biz_mng_no = psb.prk_biz_mng_no
        WHERE bpp.srvy_id = #{srvyId}
          AND psb.use_yn = 'Y'
        ORDER BY bpp.prk_biz_mng_no
    </select>

    <!-- ÏÇ¨Ïö©ÏûêÏùò ÏÇ¨ÏóÖÏ†ïÎ≥¥ ÏÉÅÏÑ∏ Ï°∞Ìöå (ÏÇ¨ÏóÖÎ™Ö Ìè¨Ìï®) -->
    <select id="selectUserBizInfoList" parameterType="String" resultType="java.util.HashMap">
        SELECT DISTINCT psb.prk_biz_mng_no,
                        psb.biz_nm,
                        psb.biz_yy,
                        psb.sido_cd,
                        psb.sigungu_cd
        FROM tb_biz_per_prklot_info bpp
                 INNER JOIN tb_prk_srvy_biz_info psb
                            ON bpp.prk_biz_mng_no = psb.prk_biz_mng_no
        WHERE bpp.srvy_id = #{srvyId}
          AND psb.use_yn = 'Y'
        ORDER BY psb.biz_yy DESC, psb.biz_nm
    </select>

    <!-- Ìú¥ÎåÄÌè∞ Î≤àÌò∏Î°ú ÏÇ¨Ïö©Ïûê Ï°∞Ìöå (Ïù∏Ï¶ùÏö©) -->
    <select id="selectUserByPhone" parameterType="string" resultType="java.util.HashMap">
        SELECT user_id   AS userId,
               user_nm   AS username,
               mbtlnum   AS phone
        FROM cpk.tb_co_user
        WHERE regexp_replace(mbtlnum, '[^0-9]', '') = regexp_replace(#{phone}, '[^0-9]', '')
        LIMIT 1
    </select>

    <!-- Î°úÍ∑∏Ïù∏ sms -->
    <insert id="sendSms" parameterType="map">
        INSERT INTO cpk.INNO_TRAN (SCHEDULE_TYPE,
                                   SUBJECT,
                                   SEND_DATE,
                                   NOW_DATE,
                                   CALLBACK,
                                   DEST_COUNT,
                                   DEST_INFO,
                                   MSG,
                                   SEND_STATUS)
        VALUES (0,
                '[ÌïúÍµ≠ÍµêÌÜµÏïàÏ†ÑÍ≥µÎã® Ïù∏Ï¶ùÎ¨∏Ïûê]',
                TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
                TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
                '07077268822',
                1,
                #{destInfo},
                #{msg},
                0)
    </insert>
</mapper>
